<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Benchmark Different Git Refs in One Run • touchstone</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css">
<script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="Benchmark Different Git Refs in One Run">
<meta property="og:description" content="A common problem of benchmarking in continuous integration is
    that the computational power of the virtual machines that run the job
    varies over time.  This package allows users to benchmark two git refs
    of the same repo in a random sequence for better comparison.">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">touchstone</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="Unreleased version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="contents col-md-9">
<div id="touchstone" class="section level1">
<div class="page-header"><h1 class="hasAnchor">
<a href="#touchstone" class="anchor"></a>touchstone</h1></div>
<p>touchstone is a tool for continuous benchmarking, in particular useful for estimating speed implications of a pull request.</p>
<!-- badges: start -->
<p><a href="https://www.tidyverse.org/lifecycle/#experimental"><img src="https://img.shields.io/badge/lifecycle-experimental-orange.svg" alt="Lifecycle: experimental"></a> <a href="https://github.com/lorenzwalthert/touchstone/actions"><img src="https://github.com/lorenzwalthert/touchstone/workflows/R-CMD-check/badge.svg" alt="R build status"></a> <!-- badges: end --></p>
<div id="installation" class="section level2">
<h2 class="hasAnchor">
<a href="#installation" class="anchor"></a>Installation</h2>
<p>You can install the package from GitHub:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># install.packages("devtools")</span>
<span class="fu">devtools</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"lorenzwalthert/touchstone"</span><span class="op">)</span></code></pre></div>
</div>
<div id="conceptual" class="section level2">
<h2 class="hasAnchor">
<a href="#conceptual" class="anchor"></a>Conceptual</h2>
<p>For your PR branch and the target branch:</p>
<ul>
<li><p>build the repo.</p></li>
<li><p>define code you want to benchmark, run it multiple times.</p></li>
<li><p>Create c/p ready text (because commenting on the PR is not so easy to implement) that you can manually insert in the PR description and plots that show how the distribution of the timings for both branches.</p></li>
</ul>
<p><img src="reference/figures/screenshot-pr-comment.png"></p>
</div>
<div id="motivation" class="section level2">
<h2 class="hasAnchor">
<a href="#motivation" class="anchor"></a>Motivation</h2>
<p>The motivation for touchstone is to provide accurate benchmarking results for package developers. The following insights were the motivation:</p>
<ul>
<li><p>Often, it does not make sense to only benchmark the feature branch and compare this result with a CI/CD run that only benchmarked th master branch, because compute power available in GitHub Actions generally varies too much. The solution to this is to benchmark the two branches in one CI/CD run and look at <em>relative difference</em> between branches. This matters in particular when running one iteration of a benchmark takes long (&gt;&gt; a few seconds) and speed implications are small. Experience with styler showed that a variation <a href="https://github.com/r-lib/styler/pull/679">around 30%</a> for identical benchmarking code is not unusual.</p></li>
<li><p>Maintaining a timeline such as the implementation of r-lib/bench is of limited use because of the first bullet. Speed implications are to be checked between two revisions.</p></li>
<li><p>R and package versions must be fixed via RSPM to allow as much continuation as possible anyways. Changing the timestamp of RSPM can happen in PRs that are only dedicated to dependency updates.</p></li>
</ul>
</div>
<div id="proposed-workflow" class="section level2">
<h2 class="hasAnchor">
<a href="#proposed-workflow" class="anchor"></a>Proposed Workflow</h2>
<p>touchstone makes it easy for you to benchmark PRs. Initialize it in your repo with</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">touchstone</span><span class="fu">::</span><span class="fu"><a href="reference/use_touchstone.html">use_touchstone</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>This will:</p>
<ul>
<li>write <code>.github/workflows/touchstone.yaml</code>: The github actions workflow file.</li>
<li>create a <code>touchstone</code> directory in the repo root with:
<ul>
<li>
<code>config.json</code> that defines how to run your benchmark. In particular, you can define a benchmarking repo, that is, code you need to run your bench mark. This repo will be cloned into <code>benchmarking_path</code>. The code you want to benchmark comes from the benchmarked repo, which in our case is the root from where you call <code><a href="reference/use_touchstone.html">use_touchstone()</a></code> and hence does not need to be defined explicitly.</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb3-1"><a href="#cb3-1"></a><span class="fu">{</span></span>
<span id="cb3-2"><a href="#cb3-2"></a>  <span class="dt">"benchmarking_repo"</span><span class="fu">:</span> <span class="st">"lorenzwalthert/here"</span><span class="fu">,</span></span>
<span id="cb3-3"><a href="#cb3-3"></a>  <span class="dt">"benchmarking_ref"</span><span class="fu">:</span> <span class="st">"ca9c8e69c727def88d8ba1c8b85b0e0bcea87b3f"</span><span class="fu">,</span></span>
<span id="cb3-4"><a href="#cb3-4"></a>  <span class="dt">"benchmarking_path"</span><span class="fu">:</span> <span class="st">"touchstone/sources/here"</span><span class="fu">,</span></span>
<span id="cb3-5"><a href="#cb3-5"></a></span>
<span id="cb3-6"><a href="#cb3-6"></a>  <span class="dt">"os"</span><span class="fu">:</span> <span class="st">"ubuntu-18.04"</span><span class="fu">,</span></span>
<span id="cb3-7"><a href="#cb3-7"></a>  <span class="dt">"r"</span><span class="fu">:</span> <span class="st">"4.0.0"</span><span class="fu">,</span></span>
<span id="cb3-8"><a href="#cb3-8"></a>  <span class="dt">"rspm"</span><span class="fu">:</span> <span class="st">"https://packagemanager.rstudio.com/all/__linux__/bionic/291"</span></span>
<span id="cb3-9"><a href="#cb3-9"></a><span class="fu">}</span></span></code></pre></div>
<ul>
<li>
<code>script.R</code>, the script that runs the benchmark. The below code will run the benchmarking expression <code><a href="https://rdrr.io/r/stats/Uniform.html">runif(100)</a></code>, give it the name <code>random_test</code>, and do this twice in total (once for each branch).</li>
</ul>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">touchstone</span><span class="fu">::</span><span class="fu"><a href="reference/benchmark_run_ref.html">benchmark_run_ref</a></span><span class="op">(</span>
random_test <span class="op">=</span> <span class="st">"runif(100)"</span>, n <span class="op">=</span> <span class="fl">2</span>
<span class="op">)</span></code></pre></div>
</li>
</ul>
<p>This is not particularly useful, since <code><a href="https://rdrr.io/r/stats/Uniform.html">runif()</a></code> is not a function from the benchmarked repo. You want to bench mark functions from your package (that don’t have the same source code in both branches). The script should contain a call to <code>touchstone::benchmarks_analyse()</code> at the end to write the required artifacts that are used downstream in the GitHub Actions workflow.</p>
</div>
<div id="status" class="section level2">
<h2 class="hasAnchor">
<a href="#status" class="anchor"></a>Status</h2>
<p>This package is experimental. It is currently used in <a href="https://github.com/r-lib/styler/blob/master/.github/workflows/benchmarking.yaml">styler</a>. We’ll further reduce boilerplate code required in the GitHub Actions workflow file and move it to <code>{touchstone}</code>.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="license">
<h2>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small><a href="https://opensource.org/licenses/mit-license.php">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a></small></li>
</ul>
</div>
<div class="developers">
<h2>Developers</h2>
<ul class="list-unstyled">
<li>
<a href="https://lorenzwalthert.netlify.com">Lorenz Walthert</a> <br><small class="roles"> Author, maintainer </small>  </li>
</ul>
</div>

  </div>
</div>


      <footer><div class="copyright">
  <p>Developed by <a href="https://lorenzwalthert.netlify.com">Lorenz Walthert</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
